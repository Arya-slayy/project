<!DOCTYPE html>
<html lang="en">
<!-- Keep all your existing head and style sections exactly the same -->

<body>
  <!-- Keep all your existing body HTML exactly the same until the script section -->

  <script>
    const modeBtns = document.querySelectorAll('.mode-btn');
    const generateBtn = document.getElementById('generate');
    const promptInput = document.getElementById('prompt');
    const resultText = document.querySelector('.result-text');
    const resultImage = document.querySelector('.result-image');
    const loader = document.querySelector('.loader');
    const errorMessage = document.querySelector('.error-message');

    let currentMode = 'text';

    modeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        modeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
        promptInput.placeholder = currentMode === 'text' 
          ? "Ask me anything..." 
          : "Describe an image you'd like me to create...";
        clearResults();
      });
    });

    function clearResults() {
      resultText.innerHTML = '';
      resultImage.style.display = 'none';
      errorMessage.style.display = 'none';
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      console.error('Error:', message);
    }

    function sanitizeAndFormatText(text) {
      // Remove any script tags for security
      text = text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
      
      // Convert markdown-style headers to proper formatting
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      
      // Add spacing after periods and line breaks
      text = text.replace(/\.\s*/g, '. ');
      text = text.replace(/\n/g, '<br>');
      
      return text;
    }

    async function generate(prompt, mode) {
      try {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt, mode }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        if (mode === 'text') {
          const data = await response.json();
          const text = data[0]?.generated_text || data.generated_text || "No response generated.";
          return sanitizeAndFormatText(text);
        } else {
          return response.blob();
        }
      } catch (error) {
        throw error;
      }
    }

    generateBtn.addEventListener('click', async () => {
      const prompt = promptInput.value.trim();
      if (!prompt) {
        showError('Please enter a prompt first.');
        return;
      }

      clearResults();
      generateBtn.disabled = true;
      loader.style.display = 'block';

      try {
        if (currentMode === 'text') {
          const generatedText = await generate(prompt, 'text');
          resultText.innerHTML = generatedText; // Changed from textContent to innerHTML
          
          // Add some styling to the result container
          resultText.style.lineHeight = '1.6';
          resultText.style.padding = '10px';
        } else {
          const imageBlob = await generate(prompt, 'image');
          const imageUrl = URL.createObjectURL(imageBlob);
          resultImage.src = imageUrl;
          resultImage.style.display = 'block';
        }
      } catch (error) {
        showError(`Generation failed: ${error.message}`);
      } finally {
        generateBtn.disabled = false;
        loader.style.display = 'none';
      }
    });
  </script>
</body>
</html>
